# ============================================================================
# LAJU FRAMEWORK - GITHUB ACTIONS AUTO DEPLOY WORKFLOW
# ============================================================================
#
# PANDUAN PENGGUNAAN:
# -------------------
# File ini adalah template GitHub Actions untuk auto-deploy aplikasi Laju
# ke server produksi Anda. Workflow ini akan berjalan otomatis setiap kali
# ada push ke branch 'main'.
#
# FLOW DEPLOYMENT:
# ----------------
# Push code ‚Üí GitHub Actions ‚Üí Run Tests ‚Üí Deploy ‚Üí Smoke Tests
#
# Dengan flow ini, Anda TIDAK PERLU build di local sebelum push.
# Cukup push source code, server yang akan melakukan build.
#
# CARA SETUP:
# -----------
# 1. Copy folder 'workflows' ke root project Anda dan rename menjadi '.github'
#    Struktur akhir: .github/workflows/deploy.yml
#
# 2. Setup GitHub Secrets di repository Anda:
#    - Buka repository GitHub > Settings > Secrets and variables > Actions
#    - Tambahkan secrets berikut:
#
#    SSH_HOST        : IP address atau domain server Anda (contoh: 123.45.67.89)
#    SSH_USER        : Username SSH server (contoh: root, ubuntu, atau user lain)
#    SSH_PRIVATE_KEY : Private key SSH untuk autentikasi (isi lengkap termasuk 
#                      -----BEGIN OPENSSH PRIVATE KEY----- dan -----END...)
#    SLACK_WEBHOOK   : (Opsional) Slack webhook URL untuk notifications
#
# 3. Pastikan server sudah di-setup:
#    - Node.js terinstall (via NVM recommended)
#    - PM2 terinstall global: npm install -g pm2
#    - Git terinstall dan repository sudah di-clone
#    - PM2 process sudah dibuat dengan nama yang sesuai (default: 'laju')
#
# 4. Sesuaikan konfigurasi di bawah:
#    - Ganti path '/root/laju' dengan path project di server Anda
#    - Ganti 'pm2 reload laju' dengan nama PM2 process Anda
#    - Ganti branch 'main' jika menggunakan branch lain
#    - Ganti 'http://your-domain.com' dengan domain production Anda
#
# CARA GENERATE SSH KEY:
# ----------------------
# Di local machine:
#   ssh-keygen -t ed25519 -C "github-actions-deploy"
#
# Copy public key ke server:
#   ssh-copy-id -i ~/.ssh/id_ed25519.pub user@server-ip
#
# Copy private key untuk GitHub Secret:
#   cat ~/.ssh/id_ed25519
#
# TROUBLESHOOTING:
# ----------------
# - Jika NVM tidak ditemukan, pastikan path NVM_DIR sesuai dengan instalasi
# - Jika PM2 tidak ditemukan, tambahkan: export PATH="$PATH:$(npm bin -g)"
# - Cek logs di GitHub Actions tab untuk melihat error detail
#
# WORKFLOW:
# ---------
# 1. Test job runs (unit, integration, E2E tests)
# 2. Jika tests pass ‚Üí Deploy job runs
# 3. Deploy job hanya jalan di main branch
# 4. Setelah deploy ‚Üí Run smoke tests
# 5. Jika smoke tests fail ‚Üí Auto-rollback
#
# ============================================================================

name: Test & Deploy

# Pemicu: Jalankan workflow ini setiap kali ada push ke branch apapun
on:
  push:
    branches: [main, develop, '*']
  pull_request:
    branches: [main, develop]

# Pekerjaan yang harus dilakukan
jobs:
  # ============================================================================
  # TEST JOB - Run all tests before deployment
  # ============================================================================
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout kode
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run unit tests
      - name: Run unit tests
        run: npm run test:unit
        continue-on-error: false

      # Run integration tests
      - name: Run integration tests
        run: npm run test:integration
        continue-on-error: false

      # Build application
      - name: Build application
        run: npm run build

      # Start dev server untuk E2E tests
      - name: Start dev server
        run: npm run start &
        shell: bash

      # Tunggu server ready
      - name: Wait for server
        run: sleep 10
        shell: bash

      # Run E2E tests
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:5555
        continue-on-error: false

      # Stop dev server
      - name: Stop dev server
        if: always()
        run: pkill -f "node.*server"
        shell: bash

  # ============================================================================
  # DEPLOY JOB - Deploy ke production (hanya jika tests pass)
  # ============================================================================
  deploy:
    needs: test  # Hanya jalan jika test job pass
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Hanya deploy di main branch

    steps:
      # Checkout kode
      - name: Checkout code
        uses: actions/checkout@v4

      # SSH ke server dan jalankan perintah deploy
      - name: SSH and run deploy commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Starting deployment..."
            
            # [SESUAIKAN] Ganti dengan path ke direktori proyek Anda
            cd /root/laju
            
            echo "üì• Pulling code from GitHub..."
            git pull origin main

            # Load NVM (diperlukan karena SSH non-interactive shell)
            echo "‚öôÔ∏è Loading NVM..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            # (Opsional) Gunakan versi Node tertentu
            # nvm use 22

            echo "üì¶ Installing dependencies..."
            npm install 

            echo "üî® Building application..."
            npm run build

            echo "üóÑÔ∏è Running database migrations..."
            npx knex migrate:latest --env production
        
            # [SESUAIKAN] Ganti 'laju' dengan nama PM2 process Anda
            echo "üîÑ Reloading PM2 process..."
            pm2 reload laju
            
            echo "‚úÖ Deployment finished!"

      # Run smoke tests setelah deployment
      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          
          # Cek health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" http://your-domain.com/health)
          if [ $response -ne 200 ]; then
            echo "‚ùå Health endpoint failed: $response"
            exit 1
          fi
          echo "‚úÖ Health endpoint OK"
          
          # Cek login page
          response=$(curl -s -o /dev/null -w "%{http_code}" http://your-domain.com/login)
          if [ $response -ne 200 ]; then
            echo "‚ùå Login page failed: $response"
            exit 1
          fi
          echo "‚úÖ Login page OK"
          
          echo "‚úÖ All smoke tests passed!"
        continue-on-error: false

      # Notify success (opsional)
      - name: Notify success
        if: success()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d '{"text":"‚úÖ Deployment successful!\n\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}"}'
          fi
          echo "‚úÖ Deployment successful!"

      # Notify failure & rollback
      - name: Notify failure & rollback
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d '{"text":"‚ùå Deployment failed!\n\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}"}'
          fi
          echo "‚ùå Deployment failed, initiating rollback..."
          
          # Auto-rollback
          - name: Rollback deployment
            uses: appleboy/ssh-action@master
            with:
              host: ${{ secrets.SSH_HOST }}
              username: ${{ secrets.SSH_USER }}
              key: ${{ secrets.SSH_PRIVATE_KEY }}
              script: |
                cd /root/laju
                git revert HEAD --no-edit
                git push origin main
                pm2 reload laju
                echo "üîÑ Rollback completed!"